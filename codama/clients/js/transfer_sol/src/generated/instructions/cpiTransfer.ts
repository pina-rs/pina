/**
 * This code was AUTOGENERATED using the Codama library.
 * Please DO NOT EDIT THIS FILE, instead use visitors
 * to add features, then rerun Codama to update it.
 *
 * @see https://github.com/codama-idl/codama
 */

import {
	type AccountMeta,
	type AccountSignerMeta,
	type Address,
	combineCodec,
	type FixedSizeCodec,
	type FixedSizeDecoder,
	type FixedSizeEncoder,
	getStructDecoder,
	getStructEncoder,
	getU64Decoder,
	getU64Encoder,
	getU8Encoder,
	type Instruction,
	type InstructionWithAccounts,
	type InstructionWithData,
	type ReadonlyAccount,
	type ReadonlyUint8Array,
	SOLANA_ERROR__PROGRAM_CLIENTS__INSUFFICIENT_ACCOUNT_METAS,
	SolanaError,
	type TransactionSigner,
	type WritableAccount,
	type WritableSignerAccount,
} from "@solana/kit";
import {
	getAccountMetaFactory,
	type ResolvedInstructionAccount,
} from "@solana/program-client-core";
import { TRANSFER_SOL_PROGRAM_ADDRESS } from "../programs";

export const CPI_TRANSFER_DISCRIMINATOR = 0;

export function getCpiTransferDiscriminatorBytes() {
	return getU8Encoder().encode(CPI_TRANSFER_DISCRIMINATOR);
}

export type CpiTransferInstruction<
	TProgram extends string = typeof TRANSFER_SOL_PROGRAM_ADDRESS,
	TAccountSender extends string | AccountMeta<string> = string,
	TAccountRecipient extends string | AccountMeta<string> = string,
	TAccountSystemProgram extends string | AccountMeta<string> =
		"11111111111111111111111111111111",
	TRemainingAccounts extends readonly AccountMeta<string>[] = [],
> =
	& Instruction<TProgram>
	& InstructionWithData<ReadonlyUint8Array>
	& InstructionWithAccounts<
		[
			TAccountSender extends string ?
					& WritableSignerAccount<TAccountSender>
					& AccountSignerMeta<TAccountSender>
				: TAccountSender,
			TAccountRecipient extends string ? WritableAccount<TAccountRecipient>
				: TAccountRecipient,
			TAccountSystemProgram extends string
				? ReadonlyAccount<TAccountSystemProgram>
				: TAccountSystemProgram,
			...TRemainingAccounts,
		]
	>;

export type CpiTransferInstructionData = { amount: bigint };

export type CpiTransferInstructionDataArgs = { amount: number | bigint };

export function getCpiTransferInstructionDataEncoder(): FixedSizeEncoder<
	CpiTransferInstructionDataArgs
> {
	return getStructEncoder([["amount", getU64Encoder()]]);
}

export function getCpiTransferInstructionDataDecoder(): FixedSizeDecoder<
	CpiTransferInstructionData
> {
	return getStructDecoder([["amount", getU64Decoder()]]);
}

export function getCpiTransferInstructionDataCodec(): FixedSizeCodec<
	CpiTransferInstructionDataArgs,
	CpiTransferInstructionData
> {
	return combineCodec(
		getCpiTransferInstructionDataEncoder(),
		getCpiTransferInstructionDataDecoder(),
	);
}

export type CpiTransferInput<
	TAccountSender extends string = string,
	TAccountRecipient extends string = string,
	TAccountSystemProgram extends string = string,
> = {
	/** The sender. Must be a signer and writable (lamports will be debited). */
	sender: TransactionSigner<TAccountSender>;
	/** The recipient. Must be writable (lamports will be credited). */
	recipient: Address<TAccountRecipient>;
	/** The system program. */
	systemProgram?: Address<TAccountSystemProgram>;
	amount: CpiTransferInstructionDataArgs["amount"];
};

export function getCpiTransferInstruction<
	TAccountSender extends string,
	TAccountRecipient extends string,
	TAccountSystemProgram extends string,
	TProgramAddress extends Address = typeof TRANSFER_SOL_PROGRAM_ADDRESS,
>(
	input: CpiTransferInput<
		TAccountSender,
		TAccountRecipient,
		TAccountSystemProgram
	>,
	config?: { programAddress?: TProgramAddress },
): CpiTransferInstruction<
	TProgramAddress,
	TAccountSender,
	TAccountRecipient,
	TAccountSystemProgram
> {
	// Program address.
	const programAddress = config?.programAddress ?? TRANSFER_SOL_PROGRAM_ADDRESS;

	// Original accounts.
	const originalAccounts = {
		sender: { value: input.sender ?? null, isWritable: true },
		recipient: { value: input.recipient ?? null, isWritable: true },
		systemProgram: { value: input.systemProgram ?? null, isWritable: false },
	};
	const accounts = originalAccounts as Record<
		keyof typeof originalAccounts,
		ResolvedInstructionAccount
	>;

	// Original args.
	const args = { ...input };

	// Resolve default values.
	if (!accounts.systemProgram.value) {
		accounts.systemProgram.value =
			"11111111111111111111111111111111" as Address<
				"11111111111111111111111111111111"
			>;
	}

	const getAccountMeta = getAccountMetaFactory(programAddress, "programId");
	return Object.freeze({
		accounts: [
			getAccountMeta("sender", accounts.sender),
			getAccountMeta("recipient", accounts.recipient),
			getAccountMeta("systemProgram", accounts.systemProgram),
		],
		data: getCpiTransferInstructionDataEncoder().encode(
			args as CpiTransferInstructionDataArgs,
		),
		programAddress,
	} as CpiTransferInstruction<
		TProgramAddress,
		TAccountSender,
		TAccountRecipient,
		TAccountSystemProgram
	>);
}

export type ParsedCpiTransferInstruction<
	TProgram extends string = typeof TRANSFER_SOL_PROGRAM_ADDRESS,
	TAccountMetas extends readonly AccountMeta[] = readonly AccountMeta[],
> = {
	programAddress: Address<TProgram>;
	accounts: {
		/** The sender. Must be a signer and writable (lamports will be debited). */
		sender: TAccountMetas[0];
		/** The recipient. Must be writable (lamports will be credited). */
		recipient: TAccountMetas[1];
		/** The system program. */
		systemProgram: TAccountMetas[2];
	};
	data: CpiTransferInstructionData;
};

export function parseCpiTransferInstruction<
	TProgram extends string,
	TAccountMetas extends readonly AccountMeta[],
>(
	instruction:
		& Instruction<TProgram>
		& InstructionWithAccounts<TAccountMetas>
		& InstructionWithData<ReadonlyUint8Array>,
): ParsedCpiTransferInstruction<TProgram, TAccountMetas> {
	if (instruction.accounts.length < 3) {
		throw new SolanaError(
			SOLANA_ERROR__PROGRAM_CLIENTS__INSUFFICIENT_ACCOUNT_METAS,
			{
				actualAccountMetas: instruction.accounts.length,
				expectedAccountMetas: 3,
			},
		);
	}
	let accountIndex = 0;
	const getNextAccount = () => {
		const accountMeta = (instruction.accounts as TAccountMetas)[accountIndex]!;
		accountIndex += 1;
		return accountMeta;
	};
	return {
		programAddress: instruction.programAddress,
		accounts: {
			sender: getNextAccount(),
			recipient: getNextAccount(),
			systemProgram: getNextAccount(),
		},
		data: getCpiTransferInstructionDataDecoder().decode(instruction.data),
	};
}
